import { NavigationEntry } from '@mintlify/models';
import { Cheerio, CheerioAPI, Element } from 'cheerio';

// Used by GitBook section scraper
export default function getLinksRecursivelyGitBook(
  linkSections: Cheerio<Element>,
  $: CheerioAPI
): NavigationEntry[] {
  return linkSections
    .map((_, s) => {
      const link = $(s);
      const linkHref = link.attr('href');

      // Skip missing links. For example, GitBook uses
      // empty divs are used for styling a line beside the nav.
      // Skip external links until Mintlify supports them
      if (
        !linkHref ||
        linkHref === '#' ||
        linkHref.startsWith('https://') ||
        linkHref.startsWith('http://')
      ) {
        return undefined;
      }

      const childLinks = link.find('ul > li > div > div > ul > li > div > a');

      if (childLinks.length > 0) {
        // Put the section link in the list of pages.
        // When we support the section itself being a link we should update this
        return {
          group: link.text(),
          pages: [linkHref, ...getLinksRecursivelyGitBook(childLinks, $)],
        };
      }

      return linkHref;
    })
    .toArray()
    .filter(Boolean);
}
